<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-SHOP - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-content { animation: slide-up 0.3s ease-out; }
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .sidebar-link.active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        /* Custom Toggle Switch */
        .toggle-checkbox:checked { background-color: #4f46e5; border-color: #4f46e5;}
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label::after { transform: translateX(100%); }
        .toggle-label::after{ content: ''; position: absolute; top: 2px; left: 2px; width: 1.25rem; height: 1.25rem; background-color: white; border-radius: 9999px; transition: transform 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Admin Panel Container -->
    <div id="admin-app">

        <!-- Login View -->
        <div id="login-view" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-center text-gray-900">Admin Panel Login</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="email" class="text-sm font-medium text-gray-700">Email address</label>
                        <input id="email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p id="login-error" class="text-sm text-red-600"></p>
                    <button type="submit" class="w-full py-2 px-4 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </form>
            </div>
        </div>

        <!-- Dashboard View (Hidden by default) -->
        <div id="dashboard-view" class="hidden">
             <header class="bg-white shadow-sm sticky top-0 z-20">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <h1 class="text-2xl font-bold text-indigo-600">E-SHOP Admin</h1>
                        <div class="flex items-center">
                            <span id="admin-email" class="text-sm text-gray-600 mr-4 hidden sm:block"></span>
                            <div class="relative">
                                <button id="menu-button" class="p-2 rounded-full hover:bg-gray-100">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                                </button>
                                <div id="menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-30">
                                    <a href="#orders" class="sidebar-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Orders</a>
                                    <a href="#products" class="sidebar-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Products</a>
                                    <a href="#banners" class="sidebar-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Banners</a>
                                    <a href="#categories" class="sidebar-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Categories</a>
                                    <a href="#coupons" class="sidebar-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Coupons</a>
                                    <a href="#settings" class="sidebar-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                                    <div class="border-t my-1"></div>
                                    <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="container mx-auto p-4 sm:p-6 lg:p-8">
                <div id="orders-panel" class="hidden">
                    <h2 class="text-2xl font-semibold mb-4">Manage Orders</h2>
                    <div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="orders-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
                <div id="products-panel" class="hidden">
                     <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Manage Products</h2><button id="add-product-btn" class="py-2 px-4 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Add New Product</button></div>
                    <div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="products-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
                <div id="banners-panel" class="hidden">
                     <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Manage Banners</h2><button id="add-banner-btn" class="py-2 px-4 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Add New Banner</button></div>
                    <div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Image</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Links to Category</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="banners-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
                <div id="categories-panel" class="hidden">
                     <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Manage Categories</h2><button id="add-category-btn" class="py-2 px-4 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Add New Category</button></div>
                    <div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="categories-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
                 <div id="coupons-panel" class="hidden">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Manage Coupons</h2><button id="add-coupon-btn" class="py-2 px-4 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Add New Coupon</button></div>
                    <div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Coupon Code</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Discount (%)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="coupons-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
                <div id="settings-panel" class="hidden">
                    <h2 class="text-2xl font-semibold mb-6">Website Settings</h2>
                    <div class="space-y-8">
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold border-b pb-2 mb-4">Payment Methods</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between"><label for="enableCOD">Enable Cash on Delivery</label><div class="relative inline-block w-10 align-middle"><input type="checkbox" id="enableCOD" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-2 appearance-none cursor-pointer"/><label for="enableCOD" class="toggle-label relative block w-10 h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
                                <div class="flex items-center justify-between"><label for="enableMobile">Enable Mobile Banking</label><div class="relative inline-block w-10 align-middle"><input type="checkbox" id="enableMobile" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-2 appearance-none cursor-pointer"/><label for="enableMobile" class="toggle-label relative block w-10 h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
                                <div><label class="block text-sm">bKash Number</label><input type="text" id="bkashNumber" class="w-full mt-1 border-gray-300 rounded-md p-2"></div>
                                <div><label class="block text-sm">Nagad Number</label><input type="text" id="nagadNumber" class="w-full mt-1 border-gray-300 rounded-md p-2"></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold border-b pb-2 mb-4">Footer & Contact</h3>
                            <div class="space-y-4">
                                <div><label class="block text-sm">WhatsApp Number (for Order button)</label><input type="text" id="whatsappNumber" class="w-full mt-1 border-gray-300 rounded-md p-2"></div>
                                <div><label class="block text-sm">Brand Info</label><textarea id="brandInfo" rows="3" class="w-full mt-1 border-gray-300 rounded-md p-2"></textarea></div>
                                <div><label class="block text-sm">About Us</label><textarea id="aboutUs" rows="3" class="w-full mt-1 border-gray-300 rounded-md p-2"></textarea></div>
                                <div><label class="block text-sm">Contact Us</label><textarea id="contactUs" rows="3" class="w-full mt-1 border-gray-300 rounded-md p-2"></textarea></div>
                                <div><label class="block text-sm">FAQ</label><textarea id="faq" rows="3" class="w-full mt-1 border-gray-300 rounded-md p-2"></textarea></div>
                                <div><label class="block text-sm">Terms & Condition</label><textarea id="terms" rows="3" class="w-full mt-1 border-gray-300 rounded-md p-2"></textarea></div>
                                <div><label class="block text-sm">Privacy Policy</label><textarea id="privacy" rows="3" class="w-full mt-1 border-gray-300 rounded-md p-2"></textarea></div>
                                <div><label class="block text-sm">Return Policy</label><textarea id="returnPolicy" rows="3" class="w-full mt-1 border-gray-300 rounded-md p-2"></textarea></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold border-b pb-2 mb-4">Social Media Links</h3>
                            <div class="space-y-4">
                                <div><label class="block text-sm">Facebook URL</label><input type="text" id="facebookUrl" class="w-full mt-1 border-gray-300 rounded-md p-2"></div>
                                <div><label class="block text-sm">Twitter URL</label><input type="text" id="twitterUrl" class="w-full mt-1 border-gray-300 rounded-md p-2"></div>
                                <div><label class="block text-sm">Instagram URL</label><input type="text" id="instagramUrl" class="w-full mt-1 border-gray-300 rounded-md p-2"></div>
                            </div>
                        </div>
                        <div class="flex justify-end"><button id="save-settings-btn" class="py-2 px-8 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Save All Settings</button></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal for Forms -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 z-40 transition-opacity opacity-0 pointer-events-none"></div>
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let db, auth;
        let categories = [];
        const adminEmails = ["admin@eshop.com"]; 
        const firebaseConfig = {
            apiKey: "AIzaSyCEMWns_UkJoxoAttHlhQHTuitc9ptUTxI",
            authDomain: "eshop-27a96.firebaseapp.com",
            projectId: "eshop-27a96",
            storageBucket: "eshop-27a96.firebasestorage.app",
            messagingSenderId: "855173438737",
            appId: "1:855173438737:web:42a28023eff674aa0d80b0"
        };
        
        const loginView = document.getElementById('login-view'), dashboardView = document.getElementById('dashboard-view'), loginForm = document.getElementById('login-form'), loginError = document.getElementById('login-error'), adminEmailEl = document.getElementById('admin-email'), logoutBtn = document.getElementById('logout-btn'), menuButton = document.getElementById('menu-button'), menuDropdown = document.getElementById('menu-dropdown');
        const contentPanels = document.querySelectorAll('main > div'), sidebarLinks = document.querySelectorAll('.sidebar-link');
        const ordersTableBody = document.getElementById('orders-table-body'), productsTableBody = document.getElementById('products-table-body'), bannersTableBody = document.getElementById('banners-table-body'), categoriesTableBody = document.getElementById('categories-table-body'), couponsTableBody = document.getElementById('coupons-table-body');
        const addProductBtn = document.getElementById('add-product-btn'), addBannerBtn = document.getElementById('add-banner-btn'), addCategoryBtn = document.getElementById('add-category-btn'), saveSettingsBtn = document.getElementById('save-settings-btn'), addCouponBtn = document.getElementById('add-coupon-btn');
        const modalOverlay = document.getElementById('modal-overlay'), modal = document.getElementById('modal'), modalContent = document.getElementById('modal-content');

        try { const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); authStateListener(); } catch (e) { console.error("Firebase init failed", e); alert("DB connection failed."); }

        function authStateListener() {
            onAuthStateChanged(auth, user => {
                if (user && adminEmails.includes(user.email)) {
                    loginView.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                    adminEmailEl.textContent = user.email;
                    setupListeners();
                    fetchAllData();
                    switch_tab('orders'); 
                } else {
                    loginView.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                    if(user) signOut(auth);
                }
            });
        }

        function setupListeners() {
            menuButton.addEventListener('click', () => menuDropdown.classList.toggle('hidden'));
            document.addEventListener('click', (e) => { if (!menuButton.contains(e.target) && !menuDropdown.contains(e.target)) menuDropdown.classList.add('hidden'); });
            sidebarLinks.forEach(link => link.addEventListener('click', e => { e.preventDefault(); switch_tab(link.hash.substring(1)); menuDropdown.classList.add('hidden'); }));
            addProductBtn.addEventListener('click', () => openProductModal());
            addBannerBtn.addEventListener('click', () => openBannerModal());
            addCategoryBtn.addEventListener('click', () => openCategoryModal());
            addCouponBtn.addEventListener('click', () => openCouponModal());
            saveSettingsBtn.addEventListener('click', saveSettings);
            modalOverlay.addEventListener('click', closeModal);
            logoutBtn.addEventListener('click', () => signOut(auth));
            
            document.body.addEventListener('click', e => {
                if(e.target.closest('.view-order-btn')) viewOrderDetails(e.target.closest('.view-order-btn').dataset.id);
                if(e.target.closest('.delete-product-btn')) deleteProduct(e.target.closest('.delete-product-btn').dataset.id);
                if(e.target.closest('.delete-banner-btn')) deleteBanner(e.target.closest('.delete-banner-btn').dataset.id);
                if(e.target.closest('.delete-category-btn')) deleteCategory(e.target.closest('.delete-category-btn').dataset.id);
                if(e.target.closest('.delete-coupon-btn')) deleteCoupon(e.target.closest('.delete-coupon-btn').dataset.id);
            });
        }

        loginForm.addEventListener('submit', async e => { e.preventDefault(); loginError.textContent = ""; try { await signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value); } catch (error) { loginError.textContent = error.message; } });
        
        function fetchAllData() { [fetchOrders, fetchProducts, fetchBanners, fetchCategories, fetchCoupons, fetchSettings].forEach(f => f()); }
        
        function switch_tab(tabId) {
            sidebarLinks.forEach(link => link.classList.toggle('active', link.hash === `#${tabId}`));
            contentPanels.forEach(panel => panel.classList.toggle('hidden', panel.id !== `${tabId}-panel`));
        }

        function openModal(content) { modalContent.innerHTML = content; modal.classList.remove('opacity-0', 'pointer-events-none'); modalOverlay.classList.remove('opacity-0', 'pointer-events-none'); }
        function closeModal() { modal.classList.add('opacity-0', 'pointer-events-none'); modalOverlay.classList.add('opacity-0', 'pointer-events-none'); modalContent.innerHTML = ''; }
        
        function openConfirmModal(message, onConfirm) {
            const modalHTML = `
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900">Confirm Action</h3>
                    <p class="mt-2 text-sm text-gray-600">${message}</p>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="confirm-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                        <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
                    </div>
                </div>
            `;
            openModal(modalHTML);
            document.getElementById('confirm-cancel-btn').addEventListener('click', closeModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
        }

        function fetchOrders() {
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(q, s => {
                ordersTableBody.innerHTML = s.empty ? '<tr><td colspan="6" class="text-center py-4 text-gray-500">No orders.</td></tr>' : '';
                s.forEach(d => {
                    const o = { id: d.id, ...d.data() }, r = document.createElement('tr');
                    const statusColor = o.status === 'delivered' ? 'bg-green-100 text-green-800' : o.status === 'shipped' ? 'bg-blue-100 text-blue-800' : o.status === 'canceled' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                    r.innerHTML = `<td class="p-3 text-sm">${o.id.substring(0,8)}...</td><td class="p-3 text-sm">${o.fullName}</td><td class="p-3 text-sm">${new Date(o.createdAt?.toDate()).toLocaleDateString()}</td><td class="p-3 text-sm">BDT ${o.grandTotal}</td><td class="p-3 text-sm"><span class="px-2 py-1 text-xs rounded-full ${statusColor}">${o.status}</span></td><td class="p-3 text-sm"><button class="view-order-btn text-indigo-600" data-id="${o.id}">Details</button></td>`;
                    ordersTableBody.appendChild(r);
                });
            }, e => { console.error(e); ordersTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading orders.</td></tr>`; });
        }

        async function viewOrderDetails(orderId) {
            const orderRef = doc(db, 'orders', orderId);
            const orderDoc = await getDoc(orderRef);
            if (!orderDoc.exists()) return;
            const order = { id: orderDoc.id, ...orderDoc.data() };
            let paymentDetailsHTML = `<div><strong>Payment Method:</strong> ${order.paymentMethod === 'cod' ? 'Cash on Delivery' : (order.paymentDetails?.provider || 'Mobile Banking')}</div>`;
            if (order.paymentMethod === 'mobile' && order.paymentDetails) {
                paymentDetailsHTML += `
                    <div><strong>Transaction ID:</strong> ${order.paymentDetails.trxId}</div>
                    <div><strong>Sender Number:</strong> ${order.paymentDetails.senderNumber}</div>
                `;
            }
            const modalHTML = `<div class="p-6"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold text-gray-900">Order Details</h3><button type="button" id="modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button></div><div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div><strong>Customer:</strong> ${order.fullName}</div><div><strong>Email:</strong> ${order.customerEmail || 'N/A'}</div><div><strong>Phone:</strong> ${order.mobileNumber}</div><div><strong>Address:</strong> ${order.address}</div><div><strong>Order Date:</strong> ${new Date(order.createdAt?.toDate()).toLocaleString()}</div><div><strong>Grand Total:</strong> BDT ${order.grandTotal.toLocaleString()}</div>${paymentDetailsHTML}</div><div class="mt-4"><h4 class="font-semibold">Items:</h4><ul class="list-disc list-inside mt-2 text-sm text-gray-600">${order.items.map(item => `<li>${item.name} (Size: ${item.size}) x ${item.quantity} - BDT ${(item.price * item.quantity).toLocaleString()}</li>`).join('')}</ul></div><div class="mt-6"><label for="status-select" class="block text-sm font-medium text-gray-700">Update Status</label><div class="flex items-center space-x-2 mt-1"><select id="status-select" class="flex-grow border-gray-300 rounded-md shadow-sm"><option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option><option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option><option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option><option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>Canceled</option></select><button id="update-status-btn" class="py-2 px-4 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Update</button></div></div></div>`;
            openModal(modalHTML);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('update-status-btn').addEventListener('click', async () => { await updateDoc(doc(db, 'orders', order.id), { status: document.getElementById('status-select').value }); closeModal(); });
        }
       
        function fetchProducts() {
            const q = query(collection(db, "products"), orderBy("category"));
             onSnapshot(q, s => {
                productsTableBody.innerHTML = s.empty ? '<tr><td colspan="4" class="text-center py-4 text-gray-500">No products.</td></tr>' : '';
                s.forEach(d => {
                    const p = { id: d.id, ...d.data() }, r = document.createElement('tr');
                    r.innerHTML = `<td class="p-3 text-sm flex items-center"><img src="${p.image}" class="w-10 h-10 rounded-md mr-4 object-cover"> ${p.name}</td><td class="p-3 text-sm">${p.category}</td><td class="p-3 text-sm">BDT ${p.price}</td><td class="p-3 text-sm"><button class="delete-product-btn text-red-600" data-id="${p.id}">Delete</button></td>`;
                    productsTableBody.appendChild(r);
                });
            }, e => console.error(e));
        }

        async function openProductModal() {
            const categoryOptions = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const modalHTML = `<form id="product-form" class="p-6 space-y-4"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold">Add New Product</h3><button type="button" id="modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button></div><div><label class="block text-sm">Product ID (Numeric)</label><input type="number" id="product-id" required class="w-full mt-1 border border-gray-300 rounded-md p-2"></div><div><label class="block text-sm">Name</label><input type="text" id="product-name" required class="w-full mt-1 border border-gray-300 rounded-md p-2"></div><div><label class="block text-sm">Description</label><textarea id="product-description" rows="3" class="w-full mt-1 border border-gray-300 rounded-md p-2"></textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm">Price</label><input type="number" id="product-price" required class="w-full mt-1 border border-gray-300 rounded-md p-2"></div><div><label class="block text-sm">Category</label><select id="product-category" required class="w-full mt-1 border border-gray-300 rounded-md p-2">${categoryOptions}</select></div></div><div><label class="block text-sm">Main Image URL</label><input type="text" id="product-image" required class="w-full mt-1 border border-gray-300 rounded-md p-2"></div><div><label class="block text-sm">Other Image URLs (comma-separated)</label><input type="text" id="product-images" class="w-full mt-1 border border-gray-300 rounded-md p-2"></div><div><label class="block text-sm">Sizes (comma-separated)</label><input type="text" id="product-sizes" required class="w-full mt-1 border border-gray-300 rounded-md p-2"></div><div class="flex justify-end pt-4"><button type="submit" class="py-2 px-6 bg-indigo-600 text-white rounded-md">Save</button></div></form>`;
            openModal(modalHTML);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('product-form').addEventListener('submit', saveProduct);
        }

        async function saveProduct(e) {
            e.preventDefault();
            const docId = document.getElementById('product-id').value;
            if (!docId) { alert("Product ID required."); return; }
            const data = {
                id: parseInt(docId), name: document.getElementById('product-name').value, description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value), category: document.getElementById('product-category').value,
                image: document.getElementById('product-image').value, images: document.getElementById('product-images').value.split(',').map(s=>s.trim()).filter(Boolean),
                sizes: document.getElementById('product-sizes').value.split(',').map(s=>s.trim()).filter(Boolean),
            };
            try {
                await setDoc(doc(db, 'products', docId), data);
                alert('Product saved successfully!');
                closeModal();
            } catch (error) {
                console.error("Error saving product:", error);
                alert(`Error: ${error.message}`);
            }
        }
        async function deleteProduct(productId) { openConfirmModal('Are you sure you want to delete this product?', async () => { try { await deleteDoc(doc(db, 'products', productId)); alert('Product deleted successfully!'); } catch (error) { console.error("Error deleting product:", error); alert(`Error: ${error.message}`); } }); }

        function fetchBanners() { onSnapshot(collection(db, "banners"), s => { bannersTableBody.innerHTML = s.empty ? '<tr><td colspan="3" class="text-center py-4 text-gray-500">No banners.</td></tr>' : ''; s.forEach(d => { const b = {id:d.id, ...d.data()}, r=document.createElement('tr'); r.innerHTML = `<td class="p-3"><img src="${b.img}" class="w-32 h-16 object-cover"></td><td class="p-3 text-sm">${b.category}</td><td class="p-3 text-sm"><button class="delete-banner-btn text-red-600" data-id="${b.id}">Delete</button></td>`; bannersTableBody.appendChild(r); }); }); }
        async function openBannerModal() { const categoryOptions = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join(''); const html=`<form id="banner-form" class="p-6 space-y-4"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold">Add Banner</h3><button type="button" id="modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button></div><label class="block text-sm">Image URL</label><input type="text" id="banner-img" required class="w-full mt-1 border border-gray-300 rounded-md p-2"><label class="block text-sm">Links to Category</label><select id="banner-category" required class="w-full mt-1 border border-gray-300 rounded-md p-2">${categoryOptions}</select><div class="flex justify-end pt-4"><button type="submit" class="py-2 px-6 bg-indigo-600 text-white rounded-md">Save</button></div></form>`; openModal(html); document.getElementById('modal-close-btn').addEventListener('click', closeModal); document.getElementById('banner-form').addEventListener('submit', saveBanner); }
        async function saveBanner(e) { e.preventDefault(); const data = {img:document.getElementById('banner-img').value, category:document.getElementById('banner-category').value}; try { await addDoc(collection(db,'banners'), data); closeModal(); } catch(e) { alert(e.message); } }
        async function deleteBanner(id) { openConfirmModal('Are you sure you want to delete this banner?', async () => await deleteDoc(doc(db, 'banners', id))); }

        function fetchCategories() { onSnapshot(collection(db, "categories"), s => { categories = s.docs.map(d => ({id:d.id, name: d.data().name})); categoriesTableBody.innerHTML = s.empty ? '<tr><td colspan="2" class="text-center py-4 text-gray-500">No categories.</td></tr>' : ''; categories.forEach(c => { const r=document.createElement('tr'); r.innerHTML=`<td class="p-3 text-sm">${c.name}</td><td class="p-3 text-sm"><button class="delete-category-btn text-red-600" data-id="${c.id}">Delete</button></td>`; categoriesTableBody.appendChild(r); }); }); }
        async function openCategoryModal() { const html=`<form id="category-form" class="p-6 space-y-4"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold">Add Category</h3><button type="button" id="modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button></div><label class="block text-sm">Name</label><input type="text" id="category-name" required class="w-full mt-1 border border-gray-300 rounded-md p-2"><div class="flex justify-end pt-4"><button type="submit" class="py-2 px-6 bg-indigo-600 text-white rounded-md">Save</button></div></form>`; openModal(html); document.getElementById('modal-close-btn').addEventListener('click', closeModal); document.getElementById('category-form').addEventListener('submit', saveCategory); }
        async function saveCategory(e) { e.preventDefault(); const data={name:document.getElementById('category-name').value}; try { await addDoc(collection(db,'categories'),data); closeModal(); } catch(e) { alert(e.message); } }
        async function deleteCategory(id) { openConfirmModal('Are you sure you want to delete this category?', async () => await deleteDoc(doc(db,'categories',id))); }
        
        function fetchCoupons() { onSnapshot(collection(db, "coupons"), s => { couponsTableBody.innerHTML = s.empty ? '<tr><td colspan="4" class="text-center py-4 text-gray-500">No coupons.</td></tr>' : ''; s.forEach(d => { const c = {id:d.id, ...d.data()}, r = document.createElement('tr'); const statusColor = c.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'; r.innerHTML=`<td class="p-3 text-sm">${c.code}</td><td class="p-3 text-sm">${c.discountPercentage}%</td><td class="p-3 text-sm"><span class="px-2 py-1 text-xs rounded-full ${statusColor}">${c.active ? 'Active' : 'Inactive'}</span></td><td class="p-3 text-sm"><button class="delete-coupon-btn text-red-600" data-id="${c.id}">Delete</button></td>`; couponsTableBody.appendChild(r); }); }); }
        async function openCouponModal() { const html=`<form id="coupon-form" class="p-6 space-y-4"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold">Add New Coupon</h3><button type="button" id="modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button></div><div><label class="block text-sm">Coupon Code (e.g., SAVE10)</label><input type="text" id="coupon-code" required class="w-full mt-1 border border-gray-300 rounded-md p-2"></div><div><label class="block text-sm">Discount Percentage</label><input type="number" id="coupon-discount" required class="w-full mt-1 border border-gray-300 rounded-md p-2"></div><div class="flex items-center"><input type="checkbox" id="coupon-active" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="coupon-active" class="ml-2 block text-sm">Active</label></div><div class="flex justify-end pt-4"><button type="submit" class="py-2 px-6 bg-indigo-600 text-white rounded-md">Save Coupon</button></div></form>`; openModal(html); document.getElementById('modal-close-btn').addEventListener('click', closeModal); document.getElementById('coupon-form').addEventListener('submit', saveCoupon); }
        async function saveCoupon(e) { e.preventDefault(); const code = document.getElementById('coupon-code').value.toUpperCase(); const data={ code, discountPercentage: parseFloat(document.getElementById('coupon-discount').value), active: document.getElementById('coupon-active').checked }; try { await setDoc(doc(db, 'coupons', code), data); alert('Coupon saved!'); closeModal(); } catch(e) { alert(e.message); } }
        async function deleteCoupon(id) { openConfirmModal('Are you sure you want to delete this coupon?', async () => { try { await deleteDoc(doc(db, 'coupons', id)); alert('Coupon deleted!'); } catch(e) { alert(e.message); } }); }

        async function fetchSettings() {
            const settingsRef = doc(db, 'settings', 'main');
            const docSnap = await getDoc(settingsRef);
            if(docSnap.exists()){
                const s = docSnap.data();
                document.getElementById('enableCOD').checked = s.enableCOD || false;
                document.getElementById('enableMobile').checked = s.enableMobileBanking || false;
                document.getElementById('bkashNumber').value = s.bkashNumber || '';
                document.getElementById('nagadNumber').value = s.nagadNumber || '';
                document.getElementById('brandInfo').value = s.brandInfo || '';
                document.getElementById('aboutUs').value = s.aboutUs || '';
                document.getElementById('contactUs').value = s.contactUs || '';
                document.getElementById('faq').value = s.faq || '';
                document.getElementById('terms').value = s.terms || '';
                document.getElementById('privacy').value = s.privacy || '';
                document.getElementById('returnPolicy').value = s.returnPolicy || '';
                document.getElementById('facebookUrl').value = s.facebookUrl || '';
                document.getElementById('twitterUrl').value = s.twitterUrl || '';
                document.getElementById('instagramUrl').value = s.instagramUrl || '';
                document.getElementById('whatsappNumber').value = s.whatsappNumber || '';
            }
        }
        
        async function saveSettings() {
            const data = {
                enableCOD: document.getElementById('enableCOD').checked,
                enableMobileBanking: document.getElementById('enableMobile').checked,
                bkashNumber: document.getElementById('bkashNumber').value,
                nagadNumber: document.getElementById('nagadNumber').value,
                brandInfo: document.getElementById('brandInfo').value,
                aboutUs: document.getElementById('aboutUs').value,
                contactUs: document.getElementById('contactUs').value,
                faq: document.getElementById('faq').value,
                terms: document.getElementById('terms').value,
                privacy: document.getElementById('privacy').value,
                returnPolicy: document.getElementById('returnPolicy').value,
                facebookUrl: document.getElementById('facebookUrl').value,
                twitterUrl: document.getElementById('twitterUrl').value,
                instagramUrl: document.getElementById('instagramUrl').value,
                whatsappNumber: document.getElementById('whatsappNumber').value,
            };
            try { await setDoc(doc(db, 'settings', 'main'), data); alert('Settings saved!'); } catch(e) { alert('Error: ' + e.message); }
        }
    </script>
</body>
</html>

